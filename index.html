<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Watchlist</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“º</text></svg>">

    <style>
        :root {
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --bg-primary: #f8f9fa; --bg-secondary: #ffffff; --bg-tertiary: #f1f3f5;
            --text-primary: #212529; --text-secondary: #6c757d; --text-tertiary: #495057;
            --border-color: #dee2e6; --accent-color: #e52d27; --accent-hover: #c21a14;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --success-color: #28a745; --danger-color: #dc3545; --info-color: #007bff;
            --warning-color: #ffc107; --border-radius-sm: 6px; --border-radius-md: 12px; --border-radius-lg: 16px;
            --transition-speed: 0.3s;
        }
        body.dark-mode {
            --bg-primary: #121212; --bg-secondary: #1e1e1e; --bg-tertiary: #2a2a2a;
            --text-primary: #e9e9e9; --text-secondary: #a0a0a0; --text-tertiary: #c0c0c0;
            --border-color: #333333; --accent-color: #ff4742; --accent-hover: #ff1f1a;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideIn { from { transform: scale(0.95) translateY(20px); } to { transform: scale(1) translateY(0); } }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary);
            padding: 2rem 1rem; display: flex; justify-content: center;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        .container { width: 100%; max-width: 1200px; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);
        }
        .header-title { display: flex; align-items: center; gap: 1rem; }
        header h1 {
            font-size: 2.25rem; font-weight: 700; color: var(--accent-color);
            background: linear-gradient(45deg, var(--accent-color), var(--accent-hover));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        #video-count-badge {
            background-color: var(--bg-tertiary); color: var(--text-secondary);
            padding: 0.25rem 0.75rem; border-radius: 1rem; font-weight: 600; font-size: 0.9rem;
        }
        .header-actions { display: flex; align-items: center; gap: 0.5rem; }
        .header-icon-btn {
            background: none; border: none; font-size: 1.3rem; color: var(--text-secondary); cursor: pointer;
            width: 44px; height: 44px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center;
            transition: color var(--transition-speed), background-color var(--transition-speed), transform 0.2s;
        }
        .header-icon-btn:hover { color: var(--text-primary); background-color: var(--bg-tertiary); }
        .add-video-section, .controls-bar {
            background-color: var(--bg-secondary); padding: 1.5rem;
            border-radius: var(--border-radius-md); box-shadow: var(--shadow); margin-bottom: 2rem;
        }
        #add-video-form { display: flex; gap: 0.75rem; }
        #video-url-input {
            flex-grow: 1; padding: 0.75rem 1rem; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm); font-size: 1rem; background-color: var(--bg-primary);
            color: var(--text-primary); transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        #video-url-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); }
        .btn {
            padding: 0.75rem 1.5rem; border: none; font-size: 1rem; font-weight: 600;
            border-radius: var(--border-radius-sm); cursor: pointer; transition: all var(--transition-speed);
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); box-shadow: var(--shadow-lg); }
        .btn-primary:active:not(:disabled) { transform: scale(0.98); }
        .btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        .btn-secondary {
            background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
            color: var(--text-tertiary);
        }
        .btn-secondary:hover { background-color: color-mix(in srgb, var(--border-color) 50%, var(--bg-tertiary)); }
        .controls-bar { display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .search-container {
            display: flex; align-items: center; background-color: var(--bg-primary);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-sm);
            padding-left: 0.75rem; flex-grow: 1; min-width: 250px;
        }
        #search-input { border: none; background: transparent; padding: 0.75rem; font-size: 1rem; color: var(--text-primary); width: 100%; }
        #search-input:focus { outline: none; }
        .control-group { display: flex; gap: 0.75rem; }
        .control-group select, .btn-danger {
            padding: 0.65rem 1rem; border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
        }
        .control-group select {
            background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
            color: var(--text-tertiary); cursor: pointer;
        }
        .btn-danger { background-color: transparent; border: 1px solid var(--danger-color); color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-color); color: white; }
        #video-list-container {
            display: grid; gap: 1.5rem;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        #video-list-container.list-view { display: flex; flex-direction: column; gap: 1rem; }
        .video-card {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md); box-shadow: var(--shadow);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .video-card.new { animation: fadeIn 0.5s ease-out forwards; }
        .list-view .video-card { flex-direction: row; align-items: flex-start; }
        .video-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .video-card.watched { filter: saturate(0.3) opacity(0.7); }
        .thumbnail-container { position: relative; flex-shrink: 0; }
        .thumbnail-container img {
            width: 100%; height: auto; aspect-ratio: 16/9; object-fit: cover; display: block;
        }
        .list-view .thumbnail-container { width: 160px; border-radius: var(--border-radius-sm); overflow: hidden;}
        .video-info { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .list-view .video-info { padding: 0 0 0 1rem; }
        .video-info h3 { margin: 0 0 0.25rem 0; font-size: 1.1rem; font-weight: 600; line-height: 1.4; }
        .video-info a { text-decoration: none; color: var(--text-primary); transition: color var(--transition-speed); }
        .video-info a:hover { color: var(--accent-color); }
        .channel-name { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .card-actions { display: flex; gap: 0.5rem; }
        .icon-btn {
            background: var(--bg-tertiary); border: none; color: var(--text-secondary);
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 0.9rem;
            display: flex; justify-content: center; align-items: center; transition: all 0.2s; position: relative;
        }
        .icon-btn:hover { transform: scale(1.1); }
        .icon-btn.watched-btn:hover { background-color: var(--success-color); color: white; }
        .icon-btn.remove-btn:hover { background-color: var(--danger-color); color: white; }
        .icon-btn.preview-btn:hover { background-color: var(--accent-color); color: white; }
        .icon-btn.schedule-btn:hover, .icon-btn.schedule-btn.active { background-color: var(--info-color); color: white; }
        [data-tooltip]::after {
            content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background-color: #333; color: white; padding: 0.4rem 0.8rem; border-radius: var(--border-radius-sm);
            font-size: 0.8rem; font-weight: 500; white-space: nowrap;
            opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; pointer-events: none; z-index: 100;
        }
        [data-tooltip]:hover::after { opacity: 1; visibility: visible; }
        .date-badge { font-size: 0.8rem; font-weight: 600; padding: 0.2rem 0.6rem; border-radius: 1rem; }
        .date-badge.overdue { background-color: var(--danger-color); color: white; }
        .date-badge.today { background-color: var(--warning-color); color: var(--text-primary); }
        .date-badge.upcoming { background-color: var(--info-color); color: white; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity var(--transition-speed), visibility var(--transition-speed); animation: modalFadeIn var(--transition-speed) forwards;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-secondary); padding: 0; border-radius: var(--border-radius-lg);
            width: 90%; position: relative; max-height: 90vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform var(--transition-speed); animation: modalSlideIn var(--transition-speed) ease-out forwards;
        }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.5rem; font-weight: 600; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.75rem; justify-content: flex-end; }
        .modal-close-btn {
            background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        }
        #preview-modal .modal-content { padding: 0; background: black; max-width: 960px; overflow: hidden; }
        #preview-player { width: 100%; aspect-ratio: 16/9; border: none; }
        #preview-modal .modal-close-btn { position: absolute; top: 0; right: 0; color: white; z-index: 10; }
        #settings-modal .modal-content, #schedule-modal .modal-content, #data-modal .modal-content { max-width: 450px; }
        #schedule-modal p { margin-bottom: 1.5rem; color: var(--text-secondary); }
        #schedule-modal input[type="date"], #data-modal textarea {
            width: 100%; padding: 0.75rem; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);
            background: var(--bg-primary); color: var(--text-primary); font-family: inherit; font-size: 1rem;
        }
        #data-modal textarea { height: 150px; resize: vertical; font-family: monospace; }
        .preference-item { display:flex; justify-content:space-between; align-items:center; padding: 1rem 0; }
        .preference-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .toggle-switch { width: 50px; height: 26px; background-color: var(--bg-tertiary); border-radius: 13px; position: relative; cursor: pointer; transition: background-color var(--transition-speed); }
        .toggle-switch::before { content: ''; position: absolute; width: 22px; height: 22px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: transform var(--transition-speed); }
        input:checked + .toggle-switch { background-color: var(--accent-color); }
        input:checked + .toggle-switch::before { transform: translateX(24px); }
        input.hidden { display: none; }
        .empty-state {
            grid-column: 1 / -1; text-align: center; color: var(--text-secondary); padding: 5rem 2rem;
            background: var(--bg-secondary); border-radius: var(--border-radius-lg); border: 2px dashed var(--border-color);
        }
        .empty-state i { font-size: 4rem; margin-bottom: 1.5rem; display: block; color: var(--border-color); }
        #toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem;
            border-radius: var(--border-radius-sm); font-weight: 500;
            box-shadow: var(--shadow-lg); transition: all 0.5s ease-in-out; z-index: 1001;
            display: flex; align-items: center; gap: 1rem; border: 1px solid #dee2e6;
        }
        #toast.show { bottom: 20px; }
        #toast .toast-icon { font-size: 1.2rem; }
        #toast.success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        #toast.info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        #toast.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; opacity: 0; visibility: hidden; transition: all var(--transition-speed);
        }
        #loading-overlay.show { opacity: 1; visibility: visible; }
        #loading-overlay .fa-spinner { font-size: 3rem; margin-bottom: 1.5rem; }
        #loading-overlay p { font-size: 1.2rem; font-weight: 500; }
        @media (max-width: 768px) { body { padding: 1rem; } header h1 { font-size: 1.75rem; } }
        @media (max-width: 600px) {
            .controls-bar { flex-direction: column; align-items: stretch; }
            .search-container, .control-group { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <h1>Watchlist</h1>
                <span id="video-count-badge">0</span>
            </div>
            <div class="header-actions">
                <button id="theme-toggle-btn" class="header-icon-btn" data-tooltip="Toggle Theme"><i class="fa-solid fa-moon"></i></button>
                <button id="settings-btn" class="header-icon-btn" data-tooltip="Settings"><i class="fa-solid fa-gear"></i></button>
            </div>
        </header>

        <section class="add-video-section">
            <form id="add-video-form">
                <input type="text" id="video-url-input" placeholder="Paste a YouTube URL or Video ID..." required>
                <button type="submit" id="add-btn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Add Video</button>
            </form>
        </section>

        <div class="controls-bar">
            <div class="search-container"><i class="fa-solid fa-search"></i><input type="text" id="search-input" placeholder="Filter by title or channel..."></div>
            <div class="control-group">
                <select id="sort-select">
                    <optgroup label="Sort By">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="title-asc">Title (A-Z)</option>
                        <option value="schedule">Schedule Date</option>
                    </optgroup>
                     <optgroup label="Filter By">
                        <option value="watched">Watched</option>
                        <option value="unwatched">Unwatched</option>
                    </optgroup>
                </select>
                <button id="clear-all-btn" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Clear All</button>
            </div>
        </div>

        <main id="video-list-container"></main>
    </div>

    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-close><i class="fa-solid fa-times"></i></button>
            <iframe id="preview-player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>
    
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Preferences</h2><button class="modal-close-btn" data-modal-close><i class="fa-solid fa-times"></i></button></div>
            <div class="modal-body">
                <div class="preference-item"><label for="layout-toggle">Use Grid Layout</label><input type="checkbox" id="layout-toggle" class="hidden"><label for="layout-toggle" class="toggle-switch"></label></div>
                <div class="preference-item"><label for="autoplay-toggle">Autoplay Previews</label><input type="checkbox" id="autoplay-toggle" class="hidden"><label for="autoplay-toggle" class="toggle-switch"></label></div>
            </div>
            <div class="modal-footer">
                <button id="manage-data-btn" class="btn btn-secondary"><i class="fa-solid fa-database"></i> Manage Data</button>
                <button id="save-settings-btn" class="btn btn-primary">Save & Close</button>
            </div>
        </div>
    </div>

    <div id="data-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Import / Export Data</h2><button class="modal-close-btn" data-modal-close><i class="fa-solid fa-times"></i></button></div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">Paste JSON to import, or load current data to copy.</p>
                <textarea id="data-textarea" placeholder="Your watchlist data will appear here..."></textarea>
            </div>
            <div class="modal-footer" style="flex-wrap: wrap; justify-content: center;">
                <button id="load-for-export-btn" class="btn btn-secondary"><i class="fa-solid fa-copy"></i> Load to Textbox</button>
                <button id="import-from-text-btn" class="btn btn-primary"><i class="fa-solid fa-paste"></i> Import from Textbox</button>
                <button id="export-file-btn" class="btn btn-secondary"><i class="fa-solid fa-download"></i> Export to File</button>
                <button id="import-file-btn" class="btn btn-secondary"><i class="fa-solid fa-upload"></i> Import from File</button>
                <input type="file" id="import-file-input" class="hidden" accept="application/json">
            </div>
        </div>
    </div>
    
    <div id="schedule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="schedule-video-title">Set "Watch By" Date</h2><button class="modal-close-btn" data-modal-close><i class="fa-solid fa-times"></i></button></div>
            <div class="modal-body"><input type="date" id="schedule-date-input"></div>
            <div class="modal-footer">
                <button id="schedule-clear-btn" class="btn btn-secondary">Clear Date</button>
                <button id="schedule-save-btn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
    
    <div id="toast"></div>
    <div id="loading-overlay"><i class="fa-solid fa-spinner fa-spin"></i><p>Processing...</p></div>

    <script>
    const App = {
        state: {
            videos: [],
            preferences: { theme: 'light', layout: 'grid', sort: 'newest', autoplay: true },
            lastDeleted: null,
            toastTimeout: null,
            currentlyEditingUrl: null,
            isNewVideoAdded: false,
        },
        constants: {
            STORAGE_KEY_VIDEOS: 'youtubeWatchlist_v2',
            STORAGE_KEY_PREFS: 'youtubeWatchlistPrefs_v2',
        },
        DOM: {},
        init() {
            this.cacheDOM();
            this.loadState();
            this.applyPreferences();
            this.bindEvents();
            this.render();
        },
        cacheDOM() {
            this.DOM = {
                body: document.body,
                listContainer: document.getElementById('video-list-container'),
                addForm: document.getElementById('add-video-form'),
                urlInput: document.getElementById('video-url-input'),
                addBtn: document.getElementById('add-btn'),
                searchInput: document.getElementById('search-input'),
                sortSelect: document.getElementById('sort-select'),
                clearAllBtn: document.getElementById('clear-all-btn'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                countBadge: document.getElementById('video-count-badge'),
                toast: document.getElementById('toast'),
                loadingOverlay: document.getElementById('loading-overlay'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                layoutToggle: document.getElementById('layout-toggle'),
                autoplayToggle: document.getElementById('autoplay-toggle'),
                manageDataBtn: document.getElementById('manage-data-btn'),
                saveSettingsBtn: document.getElementById('save-settings-btn'),
                dataModal: document.getElementById('data-modal'),
                dataTextarea: document.getElementById('data-textarea'),
                loadForExportBtn: document.getElementById('load-for-export-btn'),
                importFromTextBtn: document.getElementById('import-from-text-btn'),
                exportFileBtn: document.getElementById('export-file-btn'),
                importFileBtn: document.getElementById('import-file-btn'),
                importFileInput: document.getElementById('import-file-input'),
                previewModal: document.getElementById('preview-modal'),
                previewPlayer: document.getElementById('preview-player'),
                scheduleModal: document.getElementById('schedule-modal'),
                scheduleTitle: document.getElementById('schedule-video-title'),
                scheduleInput: document.getElementById('schedule-date-input'),
                scheduleSaveBtn: document.getElementById('schedule-save-btn'),
                scheduleClearBtn: document.getElementById('schedule-clear-btn'),
                modals: document.querySelectorAll('.modal'),
            };
        },
        bindEvents() {
            this.DOM.addForm.addEventListener('submit', this.handleAddVideo.bind(this));
            this.DOM.listContainer.addEventListener('click', this.handleCardAction.bind(this));
            this.DOM.searchInput.addEventListener('input', this.render.bind(this));
            this.DOM.sortSelect.addEventListener('change', this.handleSortChange.bind(this));
            this.DOM.clearAllBtn.addEventListener('click', this.handleClearAll.bind(this));
            this.DOM.themeToggleBtn.addEventListener('click', this.handleThemeToggle.bind(this));
            this.DOM.toast.addEventListener('click', this.handleUndo.bind(this));
            this.DOM.settingsBtn.addEventListener('click', () => this.toggleModal('settings-modal', true));
            this.DOM.saveSettingsBtn.addEventListener('click', this.handleSaveSettings.bind(this));
            this.DOM.manageDataBtn.addEventListener('click', () => this.toggleModal('data-modal', true));
            this.DOM.loadForExportBtn.addEventListener('click', this.handleTextExport.bind(this));
            this.DOM.importFromTextBtn.addEventListener('click', this.handleTextImport.bind(this));
            this.DOM.exportFileBtn.addEventListener('click', this.handleFileExport.bind(this));
            this.DOM.importFileBtn.addEventListener('click', () => this.DOM.importFileInput.click());
            this.DOM.importFileInput.addEventListener('change', this.handleFileImport.bind(this));
            this.DOM.scheduleSaveBtn.addEventListener('click', () => this.handleScheduleModalAction('save'));
            this.DOM.scheduleClearBtn.addEventListener('click', () => this.handleScheduleModalAction('clear'));
            this.DOM.modals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal') || e.target.closest('[data-modal-close]')) {
                        this.toggleModal(modal.id, false);
                    }
                });
            });
        },
        saveState() {
            localStorage.setItem(this.constants.STORAGE_KEY_VIDEOS, JSON.stringify(this.state.videos));
            localStorage.setItem(this.constants.STORAGE_KEY_PREFS, JSON.stringify(this.state.preferences));
        },
        loadState() {
            this.state.videos = JSON.parse(localStorage.getItem(this.constants.STORAGE_KEY_VIDEOS)) || [];
            const savedPrefs = JSON.parse(localStorage.getItem(this.constants.STORAGE_KEY_PREFS));
            if (savedPrefs) this.state.preferences = { ...this.state.preferences, ...savedPrefs };
        },
        applyPreferences() {
            const { theme, layout, autoplay, sort } = this.state.preferences;
            const isDark = theme === 'dark';
            this.DOM.body.classList.toggle('dark-mode', isDark);
            const themeIcon = this.DOM.themeToggleBtn.querySelector('i');
            themeIcon.className = `fa-solid ${isDark ? 'fa-sun' : 'fa-moon'}`;
            this.DOM.themeToggleBtn.dataset.tooltip = `Switch to ${isDark ? 'Light' : 'Dark'} Mode`;
            this.DOM.listContainer.className = layout === 'grid' ? 'grid-view' : 'list-view';
            this.DOM.layoutToggle.checked = layout === 'grid';
            this.DOM.autoplayToggle.checked = autoplay;
            this.DOM.sortSelect.value = sort;
        },
        render() {
            const processedVideos = this.getProcessedVideos();
            this.DOM.listContainer.innerHTML = '';
            if (processedVideos.length === 0) {
                this.DOM.listContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fa-regular fa-folder-open"></i>
                        <h3>Your Watchlist is Empty</h3>
                        <p>Paste a YouTube link or video ID above to get started.</p>
                    </div>`;
            } else {
                const fragment = document.createDocumentFragment();
                processedVideos.forEach((video, index) => {
                    const card = this.createVideoCard(video);
                    if (index === 0 && this.state.isNewVideoAdded) card.classList.add('new');
                    fragment.appendChild(card);
                });
                this.DOM.listContainer.appendChild(fragment);
            }
            this.state.isNewVideoAdded = false;
            this.DOM.countBadge.textContent = this.state.videos.length;
        },
        getProcessedVideos() {
            let processedVideos = [...this.state.videos];
            const searchTerm = this.DOM.searchInput.value.toLowerCase();
            if (searchTerm) {
                processedVideos = processedVideos.filter(v => 
                    (v.title && v.title.toLowerCase().includes(searchTerm)) || 
                    (v.channel && v.channel.toLowerCase().includes(searchTerm))
                );
            }
            const sortMethod = this.state.preferences.sort;
            if (sortMethod === 'oldest') processedVideos.reverse();
            else if (sortMethod === 'title-asc') processedVideos.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            else if (sortMethod === 'schedule') {
                processedVideos.sort((a, b) => {
                    const dateA = a.scheduledDate ? new Date(a.scheduledDate) : new Date('9999-12-31');
                    const dateB = b.scheduledDate ? new Date(b.scheduledDate) : new Date('9999-12-31');
                    return dateA - dateB;
                });
            } else if (sortMethod === 'watched') processedVideos = processedVideos.filter(v => v.watched);
            else if (sortMethod === 'unwatched') processedVideos = processedVideos.filter(v => !v.watched);
            return processedVideos;
        },
        createVideoCard(video) {
            const card = document.createElement('div');
            card.className = `video-card ${video.watched ? 'watched' : ''}`;
            card.dataset.url = video.originalUrl;
            const scheduleBtnClass = video.scheduledDate ? 'active' : '';
            const getDateBadge = (dateStr) => {
                if (!dateStr) return '';
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const scheduledDate = new Date(dateStr);
                if (scheduledDate < today) return `<span class="date-badge overdue">Overdue</span>`;
                if (scheduledDate.getTime() === today.getTime()) return `<span class="date-badge today">Today</span>`;
                return `<span class="date-badge upcoming">Upcoming</span>`;
            };
            card.innerHTML = `
                <div class="thumbnail-container"><a href="${video.originalUrl}" target="_blank" rel="noopener noreferrer"><img src="${video.thumbnail}" alt="Video thumbnail" loading="lazy"></a></div>
                <div class="video-info">
                    <h3><a href="${video.originalUrl}" target="_blank" rel="noopener noreferrer">${video.title}</a></h3>
                    <p class="channel-name">${video.channel}</p>
                    <div class="card-footer">
                        ${getDateBadge(video.scheduledDate)}
                        <div class="card-actions">
                            <button class="icon-btn preview-btn" data-tooltip="Preview"><i class="fa-solid fa-play"></i></button>
                            <button class="icon-btn schedule-btn ${scheduleBtnClass}" data-tooltip="Schedule"><i class="fa-solid fa-calendar-alt"></i></button>
                            <button class="icon-btn watched-btn" data-tooltip="${video.watched ? 'Mark Unwatched' : 'Mark Watched'}"><i class="fa-solid ${video.watched ? 'fa-undo' : 'fa-check'}"></i></button>
                            <button class="icon-btn remove-btn" data-tooltip="Remove"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            return card;
        },
        async handleAddVideo(e) {
            e.preventDefault();
            const userInput = this.DOM.urlInput.value.trim();
            if (!userInput) return;
            const videoIdRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|shorts\/|)?([a-zA-Z0-9_-]{11})/;
            const match = userInput.match(videoIdRegex);
            const videoId = match ? match[1] : (userInput.length === 11 ? userInput : null);
            if (!videoId) return this.showToast('Invalid YouTube URL or Video ID.', 'error');
            const canonicalUrl = `https://www.youtube.com/watch?v=${videoId}`;
            if (this.state.videos.some(video => video.originalUrl === canonicalUrl)) return this.showToast('This video is already in your watchlist.', 'info');
            this.DOM.addBtn.disabled = true;
            this.DOM.addBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            const videoData = await this.fetchVideoData(canonicalUrl);
            if (videoData) {
                this.state.videos.unshift(videoData);
                this.state.isNewVideoAdded = true;
                this.saveState(); this.render();
                this.DOM.urlInput.value = '';
                this.showToast('Video added successfully!', 'success');
            }
            this.DOM.addBtn.disabled = false;
            this.DOM.addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Video';
        },
        handleCardAction(e) {
            const button = e.target.closest('button.icon-btn');
            if (!button) return;
            const card = e.target.closest('.video-card');
            const url = card.dataset.url;
            const video = this.state.videos.find(v => v.originalUrl === url);
            if (button.classList.contains('remove-btn')) {
                const videoIndex = this.state.videos.findIndex(v => v.originalUrl === url);
                this.state.lastDeleted = { video: this.state.videos[videoIndex], index: videoIndex };
                this.state.videos.splice(videoIndex, 1);
                this.showToast('Video removed.', 'info', true);
            } else if (button.classList.contains('watched-btn')) {
                video.watched = !video.watched;
            } else if (button.classList.contains('preview-btn')) {
                const videoId = this.extractVideoId(url);
                this.DOM.previewPlayer.src = `https://www.youtube.com/embed/${videoId}${this.state.preferences.autoplay ? '?autoplay=1' : ''}`;
                this.toggleModal('preview-modal', true);
            } else if (button.classList.contains('schedule-btn')) {
                this.state.currentlyEditingUrl = video.originalUrl;
                this.DOM.scheduleTitle.textContent = video.title;
                this.DOM.scheduleInput.value = video.scheduledDate || '';
                this.toggleModal('schedule-modal', true);
            }
            this.saveState(); this.render();
        },
        handleSortChange(e) {
            this.state.preferences.sort = e.target.value;
            this.saveState(); this.render();
        },
        handleClearAll() {
            if (this.state.videos.length > 0 && confirm('Are you sure you want to clear your entire watchlist? This cannot be undone.')) {
                this.state.videos = [];
                this.saveState(); this.render();
                this.showToast('Watchlist cleared!', 'info');
            }
        },
        handleThemeToggle() {
            this.state.preferences.theme = this.state.preferences.theme === 'light' ? 'dark' : 'light';
            this.applyPreferences(); this.saveState();
        },
        handleUndo(e) {
            if (e.target.id === 'toast-undo-btn' && this.state.lastDeleted) {
                this.state.videos.splice(this.state.lastDeleted.index, 0, this.state.lastDeleted.video);
                this.state.lastDeleted = null;
                clearTimeout(this.state.toastTimeout);
                this.DOM.toast.className = '';
                this.saveState(); this.render();
            }
        },
        handleSaveSettings() {
            this.state.preferences.layout = this.DOM.layoutToggle.checked ? 'grid' : 'list';
            this.state.preferences.autoplay = this.DOM.autoplayToggle.checked;
            this.saveState();
            this.toggleModal('settings-modal', false);
            setTimeout(() => {
                this.applyPreferences();
                this.render();
            }, 300);
        },
        handleScheduleModalAction(action) {
            const video = this.state.videos.find(v => v.originalUrl === this.state.currentlyEditingUrl);
            if (video) {
                if (action === 'save') video.scheduledDate = this.DOM.scheduleInput.value;
                else if (action === 'clear') video.scheduledDate = null;
                this.saveState(); this.render();
            }
            this.toggleModal('schedule-modal', false);
            this.state.currentlyEditingUrl = null;
        },
        _generateSlimExportData() {
            return this.state.videos.map(v => ({ originalUrl: v.originalUrl, watched: v.watched, scheduledDate: v.scheduledDate || null }));
        },
        handleFileExport() {
            if (this.state.videos.length === 0) return this.showToast('Watchlist is empty, nothing to export.', 'info');
            const dataStr = JSON.stringify(this._generateSlimExportData(), null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'youtube-watchlist.json';
            a.click();
            URL.revokeObjectURL(url);
            this.showToast('Watchlist exported to file.', 'success');
        },
        handleTextExport() {
            if (this.state.videos.length === 0) {
                this.DOM.dataTextarea.value = '';
                return this.showToast('Watchlist is empty.', 'info');
            }
            this.DOM.dataTextarea.value = JSON.stringify(this._generateSlimExportData(), null, 2);
            this.DOM.dataTextarea.select();
            this.showToast('Data loaded into textbox for copying.', 'success');
        },
        handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => this._processImport(event.target.result);
            reader.readAsText(file);
            e.target.value = null;
        },
        handleTextImport() {
            const jsonString = this.DOM.dataTextarea.value.trim();
            if (!jsonString) return this.showToast('Textbox is empty.', 'info');
            this._processImport(jsonString);
        },
        async _processImport(jsonString) {
            try {
                const importedData = JSON.parse(jsonString);
                if (!Array.isArray(importedData)) throw new Error('Invalid format: JSON must be an array.');
                if (importedData.length > 0 && !importedData[0].originalUrl) throw new Error('Invalid format: Array items must have "originalUrl".');
                if (!confirm(`This will overwrite your current watchlist with ${importedData.length} item(s). Are you sure?`)) return;
                
                this.toggleModal('data-modal', false);
                this.showLoadingOverlay(true, `Importing ${importedData.length} videos...`);

                const newVideosPromises = importedData.map(async (slimVideo) => {
                    const fullVideoData = await this.fetchVideoData(slimVideo.originalUrl);
                    if (fullVideoData) {
                        fullVideoData.watched = slimVideo.watched || false;
                        fullVideoData.scheduledDate = slimVideo.scheduledDate || null;
                        return fullVideoData;
                    }
                    return null;
                });
                const newVideos = (await Promise.all(newVideosPromises)).filter(Boolean);
                this.state.videos = newVideos;
                this.saveState(); this.render();
                this.showToast(`Import complete! ${newVideos.length} videos loaded.`, 'success');
            } catch (error) {
                this.showToast(`Import failed: ${error.message}`, 'error');
            } finally {
                this.showLoadingOverlay(false);
            }
        },
        showToast(message, type = 'info', showUndo = false) {
            clearTimeout(this.state.toastTimeout);
            const icons = { success: 'fa-check-circle', info: 'fa-info-circle', error: 'fa-exclamation-circle' };
            this.DOM.toast.innerHTML = `<span class="toast-icon fa-solid ${icons[type]}"></span> ${message}`;
            if (showUndo) {
                const undoBtn = document.createElement('button');
                undoBtn.id = 'toast-undo-btn';
                undoBtn.textContent = 'Undo';
                undoBtn.style = "background: rgba(0,0,0,0.1); color: inherit; border: none; padding: 0.5rem 1rem; margin-left: auto; border-radius: 4px; cursor: pointer;";
                this.DOM.toast.appendChild(undoBtn);
            }
            this.DOM.toast.className = `show ${type}`;
            this.state.toastTimeout = setTimeout(() => {
                this.DOM.toast.className = '';
                if (showUndo) this.state.lastDeleted = null;
            }, 5000);
        },
        extractVideoId(url) {
            const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|shorts\/|)?([a-zA-Z0-9_-]{11})/;
            return url.match(regex)?.[1] || null;
        },
        async fetchVideoData(url) {
            const defaultData = { title: "Video Not Found", channel: "Unknown", thumbnail: "https://i.ytimg.com/vi/dQw4w9WgXcQ/hqdefault.jpg", originalUrl: url, watched: false, scheduledDate: null };
            try {
                const response = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
                if (!response.ok) return defaultData;
                const data = await response.json();
                if (data.error) return defaultData;
                return { title: data.title, channel: data.author_name, thumbnail: data.thumbnail_url, originalUrl: url, watched: false, scheduledDate: null };
            } catch (error) {
                this.showToast(`Error fetching video data for ${url}`, 'error');
                return null;
            }
        },
        toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.toggle('show', show);
                if (!show && modalId === 'preview-modal') {
                    setTimeout(() => {
                        this.DOM.previewPlayer.src = '';
                    }, 300);
                }
            }
        },
        showLoadingOverlay(show, text = 'Processing...') {
            this.DOM.loadingOverlay.querySelector('p').textContent = text;
            this.DOM.loadingOverlay.classList.toggle('show', show);
        }
    };
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
